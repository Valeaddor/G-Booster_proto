# Kugoo X1 c курком QS-S4 протокол
### Описание протокола приема-передачи данных между контроллером и дисплеем (курком)

Тут выложен только протокол, программы для его обработки `возможно будут` :shrug: размещаться в отдельных репозиториях под микроконтроллеры.


От дисплея к контроллеру МК идут UART пакеты по 15 байт с параметрами скорости 1200 8n1, и промежутками (timeout) порядка 90-100ms.

| Байт | Значение | Описание |
|:----:|:-------------:|:-----:|
| 01 | 0x01 | Первый байт сигнатуры начала пакета |
| 02 | 0x03 | Второй байт сигнатуры начала пакета |
| 03 | 0x00-0xFF | Порядковый номер пакета, от 0x00 до 0xFF потом опять начинается с 0x00 |
| 04 | 0x00 | Обычно 0x00, значение не выяснено |
| 05 | 0x05 | Значение скорости (1 = 0x05, 2 = 0x0a, 3 = 0x0f) |
| 06 | Magic | "Магический" значение которого равно XOR порядкого номера пакета и числа из таблицы x1_display [^ремарка1] |
| 07 | 0x1a | Zero-Start =  0x1a - включен, 0x18 - выключен |
| 08 | 0x00 | Обычно 0x00, значение не выяснено |
| 09 | 0x64 | ??? Мощность/токоотдача в % (0x64 = 100 это 100%) ??? |
| 10 | 0x80 | Обычно 0x80, значение не выяснено |
| 11 | 0x2c | Значение параметра акселератора, цифра 0x2с = не выжат, 0xb0 = максимальный |
| 12 | 0x2c | Обычно 0x2c, значение не выяснено |
| 13 | 0x1e | Количество магнитов МК (0x1e = 30) |
| 14 | 0x08 | Диаметр Мотор Колеса в дюймах (0x08 = 8) |
| 15 | CRC | Контрольная сумма. Считается как XOR над всеми байтами в пакете, включая заголовок. Пример: CRC = Byte01 ^ Byte02 ^...^ Byte14 |


От контроллера МК к дисплею идут UART пакеты по 15 байт с параметрами скорости 1200 8n1, и промежутками (timeout) порядка 90-100ms.

| Байт | Значение | Описание |
|:----:|:-------------:|:-----:|
| 01 | 0x36 | Байт сигнатуры начала пакета |
| 02 | 0x00-0xFF | Порядковый номер пакета, от 0x00 до 0xFF потом опять начинается с 0x00 |
| 03 | 0x00 | Обычно 0x00, значение не выяснено |
| 04 | Magic | "Магический" байт значение которого равно XOR порядкого номера пакета и числа из таблицы x1_contr [^ремарка3] |
| 05 | Magic | "Магический" байт |
| 06 | Magic | "Магический" байт |
| 07 | 0x00 | Обычно 0x00, значение не выяснено |
| 08 | Magic+ | "Магический" байт + highByte значения "скорости" (кол-во оборотов в секунду?) [^ремарка4] |
| 09 | Magic+ | "Магический" байт + lowByte значения "скорости" (кол-во оборотов в секунду?) [^ремарка4] |
| 10 | Magic+ | "Магический" байт + 0x00 обычно, возможно highByte значения тока? |
| 11 | Magic+ | "Магический" байт + (lowByte?) значения тока |
| 12 | Magic | "Магический" байт |
| 13 | Magic | "Магический" байт |
| 14 | Magic | "Магический" байт |
| 15 | CRC | Контрольная сумма. Считается как XOR над всеми байтами в пакете, включая заголовок. Пример: CRC = Byte01 ^ Byte02 ^...^ Byte14 |

##### Таблица X1_CONTR
| Порядковый номер | XOR байт|
|:----:|:----:|
| 00 | 0x5e |
| 01 | 0x22 |
| 02 | 0x5e |
| 03 | 0x22 |
| 04 | 0x2e |
| 05 | 0x2a |
| 06 | 0x2e |
| 07 | 0x2a |
| 08 | 0x2e |
| 09 | 0x22 |
| 0A | 0x2e |
| 0B | 0x22 |
| 0C | 0x5e |
| 0D | 0x5a |
| 0E | 0x5e |
| 0F | 0x5a |
| 10 | 0x5e |
| 11 | 0x42 |
| 12 | 0x5e |
| 13 | 0x42 |
| 14 | 0x4e |
| 15 | 0x4a |
| 16 | 0x4e |
| 17 | 0x4a |
| 18 | 0x4e |
| 19 | 0x42 |
| 1A | 0x4e |
| 1B | 0x42 |
| 1C | 0x1e |
| 1D | 0x1a |
| 1E | 0x1e |
| 1F | 0x1a |
| 20 | 0x1e |
| 21 | 0x22 |
| 22 | 0x1e |
| 23 | 0x22 |
| 24 | 0x2e |
| 25 | 0x2a |
| 26 | 0x2e |
| 27 | 0x2a |
| 28 | 0x2e |
| 29 | 0x22 |
| 2A | 0x2e |
| 2B | 0x22 |
| 2C | 0x1e |
| 2D | 0x1a |
| 2E | 0x1e |
| 2F | 0x1a |
| 30 | 0x1e |
| 31 | 0x02 |
| 32 | 0x1e |
| 33 | 0x02 |
| 34 | 0x0e |
| 35 | 0x0a |
| 36 | 0x0e |
| 37 | 0x0a |
| 38 | 0x0e |
| 39 | 0x02 |
| 3A | 0x0e |
| 3B | 0x02 |
| 3C | 0x5e |
| 3D | 0x5a |
| 3E | 0x5e |
| 3F | 0x5a |





[^ремарка1]: "XOR" байт "дисплея" меняется для пакетов с номерами от 0x00 до 0x3F, затем идет повторение, . Возможно есть какая-либо формула вычисления "магического" байта, но я пока не нашел.. 
[^ремарка3]: "XOR" байт "контроллера" (не равен дисплею) меняется для пакетов с номерами от 0x00 до 0x3F, затем идет повторение, .
[^ремарка4]: Это значение оборотов колеса в секунду и надо применить формулу длины окружности с диаметром колеса, пока имперически высчитал что полученное значение деленное на ??? дает цифру скорости показываемую дисплеем при диаметре колеса 8 дюймов.

